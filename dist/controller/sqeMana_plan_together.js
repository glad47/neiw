/** layuiAdmin.pro-v1.0.0 LPPL License By http://www.layui.com/admin/ */
 ;"use strict";layui.define(["admin","table","index","element","form","laydate","jsTools","optimizeSelectOption"],function(e){function t(){i.render({elem:"#sqeManaPlan_tabPcb",url:s.baseUrl+"sqe/pcborder/planTogether/list",toolbar:"#ord_sqpManaPlan_tb",cellMinWidth:80,even:!0,id:"sqeManaPlan_tabPcb",page:!0,parseData:function(e){return{code:0,data:e.page.list,count:e.page.totalCount}},cols:p,done:function(e,t,r){d("a[data='ok']").each(function(){d(this).parents("tr").css("background-color","rgba(121, 228, 119, 0.43)"),d(this).parents("td").css({"border-right":"none !important","border-bottom":"none !important"})})}})}function r(){i.render({elem:"#sqeManaPlan_tabStencil",url:s.baseUrl+"sqe/stencilorder/planTogether/list",toolbar:"#ord_sqpManaPlan_tb",cellMinWidth:80,id:"sqeManaPlan_tabStencil",page:!0,parseData:function(e){return{code:0,data:e.page.list,count:e.page.totalCount}},cols:m,done:function(e,t,r){d("a[data='ok']").each(function(){d(this).parents("tr").css("background-color","rgba(121, 228, 119, 0.43)"),d(this).parents("td").css({"border-right":"none !important","border-bottom":"none !important"})})}})}var i=layui.table,a=layui.view,l=layui.admin,n=layui.form,s=layui.setter,o=layui.element,d=layui.jquery,c=layui.laydate,u=layui.data("userInfo").isBusiness;n.render(null,"sqe-plan-together-formlist");var p,m;u?(p=[[{type:"checkbox",fixed:"left"},{field:"productNo",title:"聚谷型号",width:135,fixed:"left",sort:!0},{field:"productionType",title:"生产类别",width:110,sort:!0},{field:"currentProcess",title:"当前工序",width:160,templet:"#currentProcess",sort:!0},{field:"deliveryTime",title:"交期",width:110,templet:"#sqeManaDt",sort:!0},{field:"secondDeliveryTime",title:"二次交期",width:110,templet:"<div>{{ d.secondDeliveryTime != null ? layui.util.toDateString(d.secondDeliveryTime, 'yyyy-MM-dd') : ''}}</div>",sort:!0},{field:"gmtModified",title:"更新时间",width:177,sort:!0},{field:"currPcsNumber",title:"此次数量(PCS)",width:134,sort:!0},{field:"quantityPcs",title:"订单数量(PCS)",width:134,sort:!0},{field:"donePcsNumber",title:"已交数量(PCS)",width:134,sort:!0},{field:"surplusPcsNumber",title:"未交数量(PCS)",width:134,sort:!0},{field:"supplierContractNo",title:"合同单号",minWidth:171,sort:!0},{field:"gmtCreate",title:"签约日期",minWidth:172,sort:!0},{fixed:"right",title:"操作",toolbar:"#scmManaPlan_tabbar",minWidth:160}]],m=[[{type:"checkbox",fixed:"left"},{field:"productNo",title:"聚谷型号",width:135,fixed:"left",sort:!0},{field:"productionType",title:"生产类别",width:110,sort:!0},{field:"deliveryTime",title:"交期",width:110,templet:"#sqeManaDtS",sort:!0},{field:"gmtModified",title:"更新时间",width:177,sort:!0},{field:"quantity",title:"订单数量(PCS)",width:134,sort:!0},{field:"donePcsNumber",title:"已交数量(PCS)",width:134,sort:!0},{field:"surplusPcsNumber",title:"未交数量(PCS)",width:134,sort:!0},{field:"",title:"当前工序",width:160,templet:"#currentProcess",sort:!0},{field:"",title:"进度",width:110,sort:!0},{field:"supplierContractNo",title:"合同单号",minWidth:171,sort:!0},{field:"gmtCreate",title:"签约日期",minWidth:172,sort:!0},{fixed:"right",title:"操作",toolbar:"#scmManaPlan_tabbarS",minWidth:160}]]):(p=[[{type:"checkbox",fixed:"left"},{field:"productNo",title:"聚谷型号",width:135,fixed:"left",sort:!0},{field:"productionType",title:"生产类别",width:110,sort:!0},{field:"supplierNo",title:"供应商",width:117,sort:!0,templet:'<div>{{ d.supplierNo || "" }} {{ d.supplierNickname || "" }}</div>'},{field:"areaSq",title:"面积",width:117,sort:!0},{field:"currentProcess",title:"当前工序",width:160,templet:"#currentProcess",sort:!0},{field:"buildTime",title:"客户交期",width:110,templet:"#sqeBuildTimeC",sort:!0},{field:"deliveryTime",title:"生产交期",width:110,templet:"#sqeManaDt",sort:!0},{field:"secondDeliveryTime",title:"二次交期",width:110,templet:"<div>{{ d.secondDeliveryTime != null ? layui.util.toDateString(d.secondDeliveryTime, 'yyyy-MM-dd') : ''}}</div>",sort:!0},{field:"gmtModified",title:"更新时间",width:177,sort:!0},{field:"currPcsNumber",title:"此次数量(PCS)",width:134,sort:!0},{field:"quantityPcs",title:"订单数量(PCS)",width:134,sort:!0},{field:"donePcsNumber",title:"已交数量(PCS)",width:134,sort:!0},{field:"surplusPcsNumber",title:"未交数量(PCS)",width:134,sort:!0},{field:"supplierContractNo",title:"合同单号",minWidth:171,sort:!0},{field:"gmtCreate",title:"签约日期",minWidth:172,sort:!0},{fixed:"right",title:"操作",toolbar:"#scmManaPlan_tabbar",minWidth:120}]],m=[[{type:"checkbox",fixed:"left"},{field:"productNo",title:"聚谷型号",width:135,fixed:"left",sort:!0},{field:"productionType",title:"生产类别",width:110,sort:!0},{field:"factoryMake",title:"供应商厂编",width:117,sort:!0},{field:"supplierNickname",title:"供应商简称",width:117,sort:!0},{field:"deliveryTime",title:"交期",width:110,templet:"#sqeManaDtS",sort:!0},{field:"gmtModified",title:"更新时间",width:177,sort:!0},{field:"quantity",title:"订单数量(PCS)",width:134,sort:!0},{field:"donePcsNumber",title:"已交数量(PCS)",width:134,sort:!0},{field:"surplusPcsNumber",title:"未交数量(PCS)",width:134,sort:!0},{field:"",title:"当前工序",width:160,templet:"#currentProcess",sort:!0},{field:"",title:"进度",width:110,sort:!0},{field:"supplierContractNo",title:"合同单号",minWidth:171,sort:!0},{field:"gmtCreate",title:"签约日期",minWidth:172,sort:!0},{fixed:"right",title:"操作",toolbar:"#scmManaPlan_tabbarS",minWidth:160}]]),t();var f={orderType:1,tableOn:"sqeManaPlan_tabPcb",rowData:null};o.on("tab(sqe-plan-together-tabs-brief)",function(e){0===e.index?(f.orderType=1,f.tableOn="sqeManaPlan_tabPcb",t()):1===e.index?(f.orderType=2,f.tableOn="sqeManaPlan_tabStencil",r()):2===e.index&&(f.orderType=3)}),n.on("select(currentProcess-sel)",function(e){var t=e.value,r=f.rowData.id,a=f.rowData.onlineOid,n=f.rowData.isInternal,o="scm/ordersupplier/update";l.req({type:"post",data:{currentProcess:t,id:r,businessTypeMark:1,onlineOid:a,isInternal:n},url:s.baseUrl+o,success:function(e){layer.msg("当前工序修改成功!"),i.reload(f.tableOn)}})}),i.on("row(sqeManaPlan_tabPcb)",function(e){f.rowData=e.data}),i.on("row(sqeManaPlan_tabStencil)",function(e){f.rowData=e.data}),i.on("toolbar(sqeManaPlan_tabPcb)",function(e){var t=i.checkStatus(e.config.id),r=t.data;console.log(r);if(0==r.length)return layer.msg("请选择一条数据！"),!1;for(var a=new Array,n=0;n<r.length;n++)a.push({id:r[n].id,isInternal:r[n].isInternal,onlineOid:r[n].onlineOid,orderId:r[n].orderId,surplusPcsNumber:r[n].surplusPcsNumber,orderPcsNumber:r[n].quantityPcs,donePcsNumber:r[n].donePcsNumber,currPcsNumber:r[n].currPcsNumber,orderType:r[n].orderType});if("submit"===e.event){var o=!1;layer.confirm("确定通知出货？",function(){o||(o=!0,d.ajax({type:"post",url:s.baseUrl+"sqe/pcborder/saveShipmentOrderByPt",headers:{access_token:layui.data("layuiAdmin").access_token},data:JSON.stringify(a),contentType:"application/json;charset=utf-8",success:function(e){console.log(e),0===e.code?layer.msg("通知出货成功！"):layer.msg(e.msg),i.reload("sqeManaPlan_tabPcb"),layer.closeAll(),o=!1},error:function(){o=!1}}))})}else if("submitX"===e.event){var o=!1;layer.confirm("确定通知出货？",function(){o||(o=!0,d.ajax({type:"post",url:s.baseUrl+"sqe/pcborder/saveAllShipmentOrder",headers:{access_token:layui.data("layuiAdmin").access_token},data:JSON.stringify(a),contentType:"application/json;charset=utf-8",success:function(e){0===e.code?(layer.msg("通知出货成功！"),i.reload("sqeManaPlan_tabPcb"),layer.closeAll()):layer.msg(e.msg),o=!1},error:function(){o=!1}}))})}else if("twoDelivery"===e.event){var u=null;layer.open({title:"选择日期",type:1,icon:3,skin:"layui-layer-molv",area:["300px","200px"],content:'<div class="layui-inline" style="padding-top: 20px;">\n      <label class="layui-form-label" >二次交期:</label>\n      <div class="layui-input-inline">\n        <input type="text" class="layui-input" name="test1" id="test1" placeholder="yyyy-MM-dd">\n      </div>\n</div>',btn:["确定"],success:function(e,t){c.render({elem:"#test1",min:r[0].deliveryTime,done:function(e,t,r){u=e}})},yes:function(e){if(null==u)return void layer.msg("请选择时间");var t=new Object;t.id=r[0].id,t.secondDeliveryTime=u,l.req({type:"post",data:t,url:s.baseUrl+"sqe/pcborder/quotationTogether/update",success:function(t){layer.alert("提交成功！"),i.reload("sqeManaPlan_tabPcb"),layer.close(e)}})}})}}),i.on("tool(sqeManaPlan_tabPcb)",function(e){var t=e.data;if("edit"==e.event){var r={data:{},result:{}};r.orderType="pcb",r.data=t,l.req({type:"post",data:{oid:t.id},url:s.baseUrl+"scm/ordershipment/infoByOid",success:function(e){r.result=e.data,console.log(r),l.popup({title:"PCB交货明细",area:["702px","547px"],btn:["保存","取消"],yes:function(e,t){d("#subdetailsDelivery").click()},success:function(t,o){r.data.id;a(this.id).render("sqeManagement/iframeWindow/details_delivery",r).done(function(){n.render(),n.on("select(courierCompany)",function(e){"送货"==e.value?d("input[name='courierOrderNo']").attr("disabled",!0):d("input[name='courierOrderNo']").attr("disabled",!1),n.render()}),n.on("submit(detailsDelivery)",function(t){var t=t.field;if(null!=e.data&&(t.id=e.data.id),t.orderSupplierId=r.data.id,t.supplierNo=r.data.supplierNo,t.deliveryTime=r.data.deliveryTime,t.orderPcsNumber=r.data.quantityPcs,t.orderId=r.data.orderId,t.donePcsNumber=parseInt(d("#donePcsNumber").text()),t.surplusPcsNumber=parseInt(d("#surplusPcsNumber").text()),""!=t.courierCompany&&null!=t.courierCompany||(t.courierCompany="送货"),null==t.deliveryOrderNo||""==t.deliveryOrderNo||"undefined"==typeof t.deliveryOrderNo)return layer.alert("送货单号不能为空"),!1;if(t.orderPcsNumber!=t.donePcsNumber){if(t.currPcsNumber<=0||null==t.currPcsNumber||""==t.currPcsNumber||"undefined"==typeof t.currPcsNumber)return layer.alert("此次数量不能为空或小于0"),!1;if(t.currPcsNumber>t.surplusPcsNumber)return layer.alert("此次数量不能超过未交PCS数量！"),!1}var a=layer.load(1,{shade:[.1,"#fff"]});return l.req({type:"post",data:t,url:s.baseUrl+"sqe/pcborder/saveSo",success:function(e){layer.close(a),layer.msg("保存成功!"),i.reload("sqeManaPlan_tabPcb"),layer.close(o)},error:function(e){layer.msg("添加失败，请稍后再试！")}}),!1})})}})}})}else"search"==e.event&&l.popup({title:"查看［"+t.productNo+"］信息",shadeClose:!0,shade:!1,maxmin:!0,area:["598px","375px"],success:function(e,r){a(this.id).render("/sqeManagement/iframeWindow/pcbinfo_search_sqe",t).done(function(){})}})}),i.on("toolbar(sqeManaPlan_tabStencil)",function(e){var t=i.checkStatus(e.config.id),r=t.data;if("submit"===e.event){var a=!1;layer.confirm("确定通知出货",function(){if(0==r.length)return layer.msg("请选择一条数据！"),!1;for(var e=new Array,t=0;t<r.length;t++)e.push({id:r[t].id,isInternal:r[t].isInternal,onlineOid:r[t].onlineOid,orderId:r[t].orderId,surplusPcsNumber:r[t].surplusPcsNumber,orderPcsNumber:r[t].quantity,donePcsNumber:r[t].donePcsNumber,currPcsNumber:r[t].currPcsNumber,orderType:r[t].orderType});a||(a=!0,d.ajax({type:"post",url:s.baseUrl+"sqe/pcborder/saveShipmentOrderByPt",headers:{access_token:layui.data("layuiAdmin").access_token},data:JSON.stringify(e),contentType:"application/json;charset=utf-8",success:function(e){0===e.code?layer.msg("通知出货成功！"):layer.msg(e.msg),i.reload("sqeManaPlan_tabStencil"),layer.closeAll(),a=!1},error:function(){a=!1}}))})}else if("submitX"===e.event)if(r.length<1)layer.msg("请选择一条数据！");else{for(var l=null,n=0;n<r.length;n++)null==l?l+=r[n].id:l=l+","+r[n].id;var a=!1;layer.confirm("直接提交["+l+"]?",function(){if(!a){a=!0;for(var e=new Array,t=0;t<r.length;t++)e.push({id:r[t].id,isInternal:r[t].isInternal,onlineOid:r[t].onlineOid,orderId:r[t].orderId,surplusPcsNumber:r[t].surplusPcsNumber,orderPcsNumber:r[t].quantity,donePcsNumber:r[t].donePcsNumber,currPcsNumber:r[t].currPcsNumber,orderType:r[t].orderType});d.ajax({type:"post",url:s.baseUrl+"sqe/stencilorder/saveAllShipmentOrder",headers:{access_token:layui.data("layuiAdmin").access_token},data:JSON.stringify(e),contentType:"application/json;charset=utf-8",success:function(e){0===e.code?layer.msg("通知出货成功!!"):444===e.code&&layer.msg(e.msg),i.reload("sqeManaPlan_tabStencil"),layer.close(index),a=!1}})}})}}),i.on("tool(sqeManaPlan_tabStencil)",function(e){var t=e.data;if("edit"==e.event){var r={data:{},result:{}};r.orderType="stencil",r.data=t,l.req({type:"post",data:{oid:t.id},url:s.baseUrl+"scm/ordershipment/infoByOid",success:function(e){r.result=e.data,console.log(r),l.popup({title:"Stencil交货明细",area:["702px","547px"],btn:["保存","取消"],yes:function(e,t){d("#subdetailsDelivery").click()},success:function(e,t){r.data.id;a(this.id).render("sqeManagement/iframeWindow/details_delivery",r).done(function(){n.render(),n.on("select(courierCompany)",function(e){"送货"==e.value?d("input[name='courierOrderNo']").attr("disabled",!0):d("input[name='courierOrderNo']").attr("disabled",!1),n.render()}),n.on("submit(detailsDelivery)",function(e){layer.msg("提交");var e=e.field;return e.orderSupplierId=r.data.id,e.supplierNo=r.data.supplierNo,e.deliveryTime=r.data.deliveryTime,e.orderPcsNumber=r.data.quantity,e.orderId=r.data.orderId,e.donePcsNumber=parseInt(d("#donePcsNumber").text()),e.surplusPcsNumber=parseInt(d("#surplusPcsNumber").text()),""!=e.courierCompany&&null!=e.courierCompany||(e.courierCompany="送货"),null==e.deliveryOrderNo||""==e.deliveryOrderNo||"undefined"==typeof e.deliveryOrderNo?(layer.alert("送货单号不能为空"),!1):0==e.currPcsNumber||null==e.currPcsNumber||""==e.currPcsNumber||"undefined"==typeof e.currPcsNumber&&e.orderPcsNumber==e.donePcsNumber?(layer.alert("此次数量不能为空"),!1):(console.log(e),l.req({type:"post",data:e,url:s.baseUrl+"sqe/pcborder/saveSo",success:function(e){layer.alert("保存成功！",function(){layer.alert("提交成功！"),i.reload("sqeManaPlan_tabStencil"),layer.closeAll()})}}),!1)})})}})}})}}),n.on("submit(LAY-sqe-plan-together-search)",function(e){var t,r=e.field;1===f.orderType?t="sqeManaPlan_tabPcb":2===f.orderType&&(t="sqeManaPlan_tabStencil"),i.reload(t,{where:r})}),e("sqeMana_plan_together",{})});