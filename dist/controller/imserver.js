/** layuiAdmin.pro-v1.0.0 LPPL License By http://www.layui.com/admin/ */
 ;"use strict";layui.define(function(exports){layui.use(["layer","jquery"],function(){function createWebSocket(e,t){try{if(gdy.indexOf(currentsession)==-1)return void console.log("不是跟单员不进行连接！！");window.WebSocket||(window.WebSocket=window.MozWebSocket),window.WebSocket?(console.log("连接websocket:"+e),socket=new WebSocket(e),socket.binaryType="arraybuffer",t()):layer.msg("你的浏览器不支持websocket！")}catch(n){reconnect(e,t)}}function reconnect(e,t){reconnectflag||(reconnectflag=!0,setTimeout(function(){createWebSocket(e,t),reconnectflag=!1},2e4))}var layer=layui.layer,$=layui.jquery,setter=layui.setter,websocketurl=setter.webSocketUrl,currentsession=layui.data("layuiAdmin").userId+"";console.log(currentsession);var showmsg,lm,reconnectflag=!1,socket,gdy=["12","17","18","20"],sendMsg=function(e,t,n){var s=new proto.Model,r=new proto.MessageBody;s.setMsgtype(4),s.setCmd(5),s.setGroupid(n),s.setToken(currentsession),s.setSender(currentsession),s.setReceiver(t),r.setContent(e),r.setType(0),s.setContent(r.serializeBinary()),socket.send(s.serializeBinary())},showOfflineMsg=function(e){$.ajax({type:"post",url:setter.imUrl+"getOfflineMsg",data:{receiveUserId:currentsession},async:!0,success:function(t){var n=t.data;if(null!=n&&n.length>0)for(var s=0;s<n.length;s++)e.getMessage({username:n[s].sendusername,avatar:n[s].avatar+"?"+(new Date).getTime(),id:n[s].sendUser,type:"friend",content:n[s].content,timestamp:n[s].createdate})}})};showmsg=function showmsg(data){var msg=eval("("+data.user+")"),content=eval("("+data.content+")"),cache=layui.layim.cache(),local=layui.data("layim")[cache.mine.id],username="",avatar="",friend=!1;if(layui.each(cache.friend,function(e,t){if(layui.each(t.list,function(e,t){if(t.id==msg.sender)return username=t.username,avatar=t.avatar,friend=!0}),friend)return!0}),3==msg.cmd)msg.sender!=currentsession&&(layer.msg(username+"上线了"),lm.setFriendStatus(msg.getSender(),"online"));else if(4==msg.cmd)msg.sender!=currentsession&&(layer.msg(username+"下线了"),lm.setFriendStatus(msg.getSender(),"offline"));else if(5==msg.cmd&&msg.sender!=currentsession){var time=new Date(msg.timeStamp).getTime();null==msg.groupId||msg.groupId.length<1?lm.getMessage({username:username,avatar:avatar+"?"+(new Date).getTime(),id:msg.sender,type:"friend",content:content.content,timestamp:time}):lm.getMessage({username:username,avatar:avatar+"?"+(new Date).getTime(),id:msg.groupId,type:"group",content:content.content,timestamp:time})}},layui.use("layim",function(e){e.config({init:{url:setter.imUrl+"getAllFriend",type:"get",data:{bid:layui.data("layuiAdmin").userId}},title:"我的IM",notice:!0,members:{url:"",type:"get",data:{}},uploadImage:{url:setter.imUrl+"file/fileupload",type:setter.imUrl+"file/fileupload"},uploadFile:{url:"fileupload",type:"post"},isAudio:!1,isVideo:!1,brief:!1,min:!0,isgroup:!0,voice:!1,copyright:!0,msgbox:"message",chatLog:layui.cache.dir+"css/modules/layim/html/chatlog.html"}),e.on("ready",function(t){lm=layui.layim,showOfflineMsg(e),e.setFriendStatus(currentsession,"online")}),e.on("sendMessage",function(e){console.log(e);var t=e.to,n=e.mine,s=n.content,r=t.id+"";if(""!=$.trim(currentsession))return""==$.trim(s)?void layer.msg("请输入要发送的消息!"):window.WebSocket?void(socket.readyState==WebSocket.OPEN&&("friend"==t.type?sendMsg(s,r,null):sendMsg(s,null,r))):void("friend"==t.type?Imwebserver.sendMsg(r,s):Imwebserver.sendGroupMsg(r,s))}),e.on("online",function(e){});var t=function n(){socket.onmessage=function(t){if(t.data instanceof ArrayBuffer){var n=proto.Model.deserializeBinary(t.data),s=proto.MessageBody.deserializeBinary(n.getContent()),r=layui.layim.cache(),i=(layui.data("layim")[r.mine.id],""),a="/images/0.jpg",o=!1;if(layui.each(r.friend,function(e,t){if(layui.each(t.list,function(e,t){if(t.id==n.getSender())return i=t.username,a=t.avatar,o=!0}),o)return!0}),2==n.getCmd()){var c=new proto.Model;c.setCmd(2),c.setMsgtype(4),socket.send(c.serializeBinary())}else if(3==n.getCmd())n.getSender()!=currentsession&&(layer.msg(i+"上线了！"),e.setFriendStatus(n.getSender(),"online"));else if(4==n.getCmd())n.getSender()!=currentsession&&(layer.msg(i+"已下线！"),e.setFriendStatus(n.getSender(),"offline"));else if(n.getSender()!=currentsession){var l=new Date(n.getTimestamp()).getTime();null==n.getGroupid()||n.getGroupid().length<1?lm.getMessage({username:i,avatar:a+"?"+(new Date).getTime(),id:n.getSender(),type:"friend",content:s.getContent(),timestamp:l}):lm.getMessage({username:i,avatar:a+"?"+(new Date).getTime(),id:n.getGroupid(),type:"group",content:s.getContent(),timestamp:l})}}else{t.data}},socket.onopen=function(e){var t=new proto.Model,n=BrowserUtil.info();t.setVersion("1.0"),t.setDeviceid(""),t.setCmd(1),t.setSender(currentsession),t.setMsgtype(1),t.setFlag(1),t.setPlatform(n.name),t.setPlatformversion(n.version),t.setToken(currentsession);var s=t.serializeBinary();socket.send(s)},socket.onclose=function(t){e.setFriendStatus(currentsession,"offline"),reconnect(websocketurl,n)},socket.onerror=function(){reconnect(websocketurl,n)}};createWebSocket(websocketurl,t)})}),exports("imserver",{})});