<link href="../../../src/style/formSelects-v4.css" rel="stylesheet" />
<div class="layui-fluid">
    <script type="text/html" template lay-done="layui.data.done(d);">
    <div class="layui-form outbound-order-search" data-type="search-form" reload-table="iqcMana_outBound">
        <div class="layui-form-item">
            <div class="layui-inline">
                <label class="layui-form-label">内部编码</label>
                <div class="layui-input-inline">
                    <input type="text" name="productNo" id="inputGiProductNo" autocomplete="off" class="layui-input">
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label">客户型号</label>
                <div class="layui-input-inline" style="width: 320px;">
                    <select id="giPcbName" name="giPcbName" xm-select-height="34px" xm-select="giPcbName" xm-select-radio  xm-select-search="" xm-select-search-type="dl">
                        <option value="" id="0">选择客户</option>
                    </select>
                </div>
            </div>
            <div class="layui-inline">
                <button class="layui-btn layuiadmin-btn-list" lay-submit lay-filter="outbound-order-search">
                    <i class="layui-icon layui-icon-search layuiadmin-button-btn"></i>
                </button>
            </div>
        </div>
        <button class="gi-submit">POSTDATA</button>
    </div>
    <table id="addGenerateInvoiceTab" lay-filter="addGenerateInvoiceTab"></table>
    </script>
    <script type="text/html" id="addGenerateInvoiceTab_tabbar">
        <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="delGi">删除</a>
    </script>
    <script id="giPF" type="text/html">
        {{# if(d.orderNo != null){ }}
        <strong>P/O：</strong>{{ d.orderNo }}
        {{# } }}

        <p>
            {{# if(d.pcbName != null){ }}
            {{ d.pcbName }}
            {{# } else if(d.gerberName != null){ }}
            {{ d.gerberName }}
            {{# } }}
        </p>
    </script>
    <script id="giPrice" type="text/html">
        {{ parseFloat(d.boardFee/d.quantityPcs).toFixed(3) }}
    </script>
</div>
<script>
    layui.data.done = function(d){
        layui.use(['table', 'index', 'form', 'jsTools', 'formSelects', 'arrReduce', 'jsTools'], function () {
            var $ = layui.jquery
                ,table = layui.table
                ,requestInterface = layui.requestInterface
                ,jsTools = layui.jsTools
                ,formSelects = layui.formSelects
                ,arrReduce = layui.arrReduce
                ,jsTools = layui.jsTools
                ,form = layui.form;

            var searchData;

            formSelects.render('giPcbName');
            initInvoiceTab();
            document.getElementById("inputGiProductNo").addEventListener('keyup', function (event) {
                jsTools.throttle(getFrom, null, 500, this.value, 2000)
            });
            function initInvoiceTab() {
                table.render({
                   elem: '#addGenerateInvoiceTab'
                    ,id: 'addGenerateInvoiceTab'
                    ,data: d.params
                    ,page: false
                    ,limit: 10000
                    ,cols: [[
                        {type: 'numbers', title: '序号', align:'center',edit: 'text'}
                        ,{field: '', title: 'P/O&File Name', align: 'center',edit: 'text', templet: '#giPF'}
                        ,{field: 'quantityPcs', title: 'QTY', align: 'center',edit: 'text'}
                        ,{field: '', title: 'Price', align: 'center',edit: 'text', templet: 'giPrice'}
                        ,{field: 'engineeringFee', title: 'Engineering Fee', align: 'center',edit: 'text'}
                        ,{field: 'testCostFee', title: 'Test Fee', align: 'center',edit: 'text'}
                        ,{field: 'toolingFee', title: 'Tooling Fee', align: 'center',edit: 'text'}
                        ,{field: 'overworkFee', title: 'Overwork Fee', align: 'center',edit: 'text'}
                        ,{field: '', title: 'Freight Fee', align: 'center',edit: 'text', templet: 'giFF'}
                        ,{field: 'pcbaSubtotalFee', title: 'PCBA Fee', align: 'center',edit: 'text'}
                        ,{field: '', title: 'Amount( USD )', align: 'center',edit: 'text'}
                        ,{fixed: 'right', title:'操作', toolbar: '#addGenerateInvoiceTab_tabbar',width: 80, align:'center'}
                    ]]
                });
            }

            table.on('tool(addGenerateInvoiceTab)', function (obj) {
                var data = obj.data;
                if (obj.event == 'delGi') {
                    layer.confirm('真的删除行么', function (index) {
                        obj.del();
                        layer.close(index);
                    })
                }
            });

            table.on('edit(addGenerateInvoiceTab)', function (obj) {
                var value = obj.value
                    ,data = obj.data //得到所在行所有键值
                    ,field = obj.field; //得到字段
                console.log(data)
            });

            function saveField() {
                admin.req({
                    type: 'post',
                    data: '',
                    url: setter.baseUrl + '',
                    success: function () {
                        layer.msg('修改成功！');
                    },
                    error: function (e) {
                        layer.msg(e);
                    }
                })
            }


            /**
             *  获取下拉列表
             **/
            function getFrom(e) {
                // var thisFrom = arr.reduce((prev, cur) => {
                //     if (cur.productNo) {
                //         prev[0].productNo.push(cur.productNo);
                //     }
                //     if (cur.pcbName) {
                //         prev[1].pcbName.push(cur.pcbName)
                //     }
                //     return prev;
                // },[{productNo: []}, {pcbName: []}]);
                layer.msg("搜索结果加载中...");
                admin.req({
                    type: 'post',
                    url: setter.baseUrl+'epc/pcborder/internalContract?access_token='+ layui.data('layuiAdmin').access_token + '&productNo=' + e + '&uId=' + d.params[0].userId + '&limit=100000',
                    success: function (res) {
                        layer.msg("加载成功！");
                        var data = res.page.list;
                        creatFormSelect(data);
                        searchData = data;
                        // $("dl[xid='giPcbName']").show();
                    }
                })
            }

            // $("div").delegate(".xm-select-title", "click", function () {
            //     $(this).hide();
            //     $("dl[xid='giPcbName']").hide();
            // });

            layui.formSelects.on('giPcbName', function (id, vals, val, isAdd, isDisabled) {
                var $thisName = val.name;
                var _val = val.value;
                layer.msg(_val)
                var selectClickData = searchData.reduce((prev, cur) => {
                    if (cur.id && cur.pcbName) {
                        if (cur.id == _val && cur.pcbName == $thisName) {
                            d.params.push(cur);
                        }
                    }
                    return prev;
                }, 0);
                initInvoiceTab();
            });


            /**
             * 初始化 下拉
             * @param data
             */
            function creatFormSelect(data) {
                var $html;
                $("select[xm-select='giPcbName'] option").remove();
                for (let p of data) {
                    $html += "<option value="+p.id+">"+p.pcbName+"</option>"
                }
                $("select[xm-select='giPcbName']").append($html);
                formSelects.render('giPcbName');
                $("dl[xid='giPcbName']").parents(".layui-input-inline").click();
            }

            function addOrderInvoice() {
                console.log('发数据为： ');
                console.log(d.params);
                // admin.req({
                //     type: 'ppost',
                //     data: d.params,
                //     url: setter.baseUrl + 'epc/orderinvoice/addOrderInvoice',
                //     success: function (res) {
                //
                //     }
                // })
            }

            $(".gi-submit").on('click', function () {
                addOrderInvoice();
            });
        });
    }
</script>
