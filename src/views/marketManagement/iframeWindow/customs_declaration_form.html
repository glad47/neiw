<title>添加报关单</title>
<script type="text/html" template>
    <link rel="stylesheet" href="{{ layui.setter.base }}style/formSelects-v4.css?v={{ layui.admin.v }}-1" />
</script>
<div class="layui-fluid">
    <script type="text/html" template lay-done="layui.data.sendParams(d.params)">
    <div class="layui-form" lay-filter="market-customs-declaration-form">
        <div class="layui-form-item">
            <div class="layui-col-md6">
                <label class="layui-form-label">客户编号</label>
                <div class="layui-input-inline">
                        <select name="receiverId" xm-select-height="34px" xm-select="receiverId" xm-select-radio  xm-select-search="" xm-select-search-type="dl" lay-verify="required">
                            {{# if(d.params.receiverId != null){ }}
                            <option class="def-option" value="{{d.params.receiverId}}" selected>{{d.params.customerNo}}</option>
                            {{# } }}
                        </select>
                        <!-- <input type="text" name="customerNo" autocomplete="off" class="layui-input" value="{{ d.params.customerNo || ''}}" lay-verify="required"> -->
                        <input type="hidden" name="id" value="{{ d.params.id || '' }}">
                        <input type="hidden" name="customerNo" value="{{d.params.customerNo || ''}}">
                </div>
            </div>
            <div class="layui-col-md6">
                <label class="layui-form-label">下单时间</label> 
                <div class="layui-input-inline">
                    <input type="text" name="orderTime" id="orderTime" autocomplete="off" class="layui-input" value="{{ d.params.orderTime || ''}}" lay-verify="required">
                </div>
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-col-md6">
                <label class="layui-form-label">海关编号</label> 
                <div class="layui-input-inline">
                    <input type="text" name="ccrn" autocomplete="off" class="layui-input" value="{{ d.params.ccrn || ''}}">
                </div>
            </div>
            <div class="layui-col-md6">
                <label class="layui-form-label">提运单号</label> 
                <div class="layui-input-inline">
                    <input type="text" name="deliveryNo" autocomplete="off" class="layui-input" value="{{ d.params.deliveryNo || ''}}">
                </div>
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-col-md6">
                <label class="layui-form-label">成交方式</label> 
                <div class="layui-input-inline">
                    <input type="text" name="tradeType" autocomplete="off" class="layui-input" value="{{ d.params.tradeType || ''}}">
                </div>
            </div>
            <div class="layui-col-md6">
                <label class="layui-form-label">商品编号</label> 
                <div class="layui-input-inline">
                    <input type="text" name="goodsNo"autocomplete="off" class="layui-input" value="{{ d.params.goodsNo || ''}}">
                </div>
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-col-md6">
                <label class="layui-form-label">境内货源地</label> 
                <div class="layui-input-inline">
                    <input type="text" name="sourceSupply" autocomplete="off" class="layui-input" value="{{ d.params.sourceSupply || ''}}">
                </div>
            </div>
            <div class="layui-col-md6">
                <label class="layui-form-label">征免</label> 
                <div class="layui-input-inline">
                    <input type="text" name="zm" autocomplete="off" class="layui-input" value="{{ d.params.zm || ''}}">
                </div>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label"></label>
            <div class="layui-input-inline">
                <button class="layui-btn  layui-btn-danger" lay-active="e1">添加</button>
                <button class="layui-btn  layui-btn-normal" lay-active="e2">删除</button>
                <input type="button" id="mcdfs" lay-submit lay-filter="market-customs-declaration-form-submit" value="确认" class="layui-btn" style="display: none;" >
            </div>
        </div>
    </div>
    </script>
    <table id="market-packing-list-en-table" lay-filter="market-packing-list-en-table"></table>
</div>

<script>
    layui.data.sendParams = function(params){
        // console.log(params);
        var ddd = params.itemEntityList || [];
         
        layui.use(['admin', 'table', 'util', 'form','requestInterface','formSelects','laydate'], function(){
            var $ = layui.$
            ,admin = layui.admin
            ,view = layui.view
            ,table = layui.table
            ,setter = layui.setter
            ,form = layui.form
            ,requestInterface = layui.requestInterface
            ,formSelects = layui.formSelects
            ,util = layui.util
            ,laydate = layui.laydate;

            form.render(null,'market-customs-declaration-form');
            laydate.render({
                elem: "#orderTime"
            })
            initSelCustomer();

            table.render({
                elem: '#market-packing-list-en-table'
                ,data: ddd
                ,totalRow: false
                ,cellMinWidth: 90
                ,cols: [[
                    {field: 'marks',  title: '唛头', align:'center', totalRowText:'Total',edit: 'text'}
                    ,{field: 'qty', title: "数量", align:'center', totalRow: true,edit: 'text'}
                    ,{field: 'packages', title: '件数', align:'center', totalRow: true,edit: 'text'}
                    ,{field: 'description', align:'center', title: '品名及规格',edit: 'text'}
                    ,{field: 'grossWeight', align:'center', title: '毛重', totalRow: true,edit: 'text'}
                    ,{field: 'netWeight', align:'center', title: '净重', totalRow: true,edit: 'text'}
                    ,{field: 'measurement', align:'center', title: '尺寸',edit: 'text'}
                    ,{field: 'unitPrice', align:'center', title: '单价', edit: 'text'}
                    ,{field: 'totalPrice', align:'center', title: '总价', edit: 'text'}
                    ,{field: 'orderNo', align:'center', title: '订单号码',edit: 'text'}
                    // ,{field: 'commercialInvoiceno', align:'center', title: '发票号码',edit: 'text'}
                ]]
            });

              /**
             * 初始化下拉， 获取所有客户信息
             */
            function initSelCustomer() {
                var _obj = requestInterface.getAllCustomer();
                var $html;
                for (let c of _obj) {
                    $html += "<option value="+c.id+">"+c.userSystemId+"</option>"
                }
                $("select[xm-select='receiverId']").append($html);
                formSelects.render('receiverId');
                // formSelects.value('giCustomer', []);
                // $(".xm-select-parent[fs_id='"+dom+"']").children(".xm-form-select").addClass("xm-form-selected");
            }

            formSelects.on('receiverId', function (id, vals, val, isAdd, isDisabled) {
                //id:           点击select的id
                //vals:         当前select已选中的值
                //val:          当前select点击的值
                //isAdd:        当前操作选中or取消
                //isDisabled:   当前选项是否是disabled                    
                if(isAdd){//对form赋值
                  form.val("market-customs-declaration-form",{"customerNo":val.name});
                }else{
                   form.val("market-customs-declaration-form",{"customerNo":null});
                }
            });
    
            //监听but
            util.event('lay-active',{
                e1: function(){
                    let oldData = table.cache["market-packing-list-en-table"],d={};
                    oldData.push(d);
                    // console.log(oldData);
                    table.reload('market-packing-list-en-table',{data:oldData})
                },
                e2: function(){
                    layer.confirm("你确定要删除么？",function(){  
                        let oldData = table.cache["market-packing-list-en-table"]; 
                        // console.log(oldData); 
                        oldData.splice(oldData.length-1,1);  
                        layer.msg("删除成功",{time: 10},function(){  
                            table.reload('market-packing-list-en-table',{data : oldData});  
                        });  
                    }) 
                }
            })
        });
    }
</script>