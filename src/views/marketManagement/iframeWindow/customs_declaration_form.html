<title>添加报关单</title>
<link href="../../../src/style/formSelects-v4.css" rel="stylesheet" />
<style>
    /* 防止下拉框的下拉列表被隐藏---必须设置--- 此样式和表格的样式有冲突 如果表格列数太多 会出现错乱的情况 目前我的解决方法是忽略下拉框的美化渲染 <select lay-ignore> */
    .layui-table-cell {
        overflow: visible;
    }
    
    .layui-table-box {
        overflow: visible;
    }
    
    .layui-table-body {
        overflow: visible;
    }
    /* 设置下拉框的高度与表格单元相同 */
    td .layui-form-select{
        margin-top: -10px;
        margin-left: -15px;
        margin-right: -15px;
    }
    .xm-select-parent{
        position: absolute;
        top: -4px;
        width: 100%;
        left: 0;
    }

</style>
<div class="layui-fluid">
    
    <div class="layui-form" lay-filter="market-customs-declaration-form">
        
        <div class="layui-form-item">
            <div class="layui-col-md6">
                <label class="layui-form-label">客户编号</label>
                <div class="layui-input-inline">
                    <script type="text/html" template>
                    <select name="receiverId" xm-select-height="34px" xm-select="receiverId" xm-select-radio  xm-select-search="" xm-select-search-type="dl" lay-verify="required"></select>
                    <!-- <input type="text" name="customerNo" autocomplete="off" class="layui-input" value="{{ d.params.customerNo || ''}}" lay-verify="required"> -->
                    <input type="hidden" name="id" value="{{ d.params.id || '' }}">
                    <input type="hidden" name="customerNo" value="{{d.params.customerNo || ''}}">
                    </script>
                </div>
            </div>
            <div class="layui-col-md6">
                <label class="layui-form-label">下单时间</label> 
                <div class="layui-input-inline">
                    <script type="text/html" template>
                    <input type="text" name="orderTime" id="orderTime" autocomplete="off" class="layui-input" value="{{ d.params.orderTime || ''}}" lay-verify="required">
                    </script>
                </div>
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-col-md6">
                <label class="layui-form-label">成交方式</label> 
                <div class="layui-input-inline">
                    <script type="text/html" template lay-done="layui.data.done(d)" lay-url="{{layui.setter.baseUrl}}sys/dict/commonSelectData" lay-data="{tableName:'客户管理',fileName:'发货方式'}" lay-type="post">
                    <select name="tradeType">
                        {{# 
                            layui.each(d.data, function(index, item){   
                        }}
                        <option value=""></option>
                        <option value="{{ item.dictKey || ''}}" {{ d.params.tradeType == item.dictKey ? 'selected' : ''}}>{{ item.dictValue }}</option>
                        {{#  }); }}
                        {{#  if(d.data.length === 0){ }}
                        无数据 
                        {{#  } }}
                    </select>
                    </script>
                </div> 
            </div>
            <div class="layui-col-md6">
                <label class="layui-form-label">提运单号</label> 
                <div class="layui-input-inline">
                    <script type="text/html" template>
                    <input type="text" name="deliveryNo" autocomplete="off" class="layui-input" value="{{ d.params.deliveryNo || ''}}">
                    </script> 
                </div>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label"></label>
            <div class="layui-input-inline">
                <script type="text/html" template>
                <button class="layui-btn layuiadmin-btn-list layui-btn-danger" data-type="e1">添加</button>
                <button class="layui-btn layuiadmin-btn-list layui-btn-normal" data-type="e2">删除</button>
                <input type="button" id="mcdfs" lay-submit lay-filter="market-customs-declaration-form-submit" value="确认" class="layui-btn" style="display: none;" >
                </script>
            </div>
        </div>
        
    </div>
    <table id="market-packing-list-en-table" lay-filter="market-packing-list-en-table"></table>
    <script type="text/html" id="goodsSelect">
        <select name="goods" xm-select="select15" xm-select-radio>
            <option value="">请选择</option>
        </select>
    </script>
</div>

<script>
    layui.data.done = function(d){
        console.log(d);
        var ddd = d.params.itemEntityList || [],rid = d.params.receiverId;
        layui.use(['admin', 'table', 'util', 'form','requestInterface','formSelects','laydate'], function(){
            var $ = layui.$
            ,admin = layui.admin
            ,view = layui.view
            ,table = layui.table
            ,setter = layui.setter
            ,form = layui.form
            ,requestInterface = layui.requestInterface
            ,formSelects = layui.formSelects
            ,util = layui.util
            ,laydate = layui.laydate;

            
            laydate.render({
                elem: "#orderTime"
            })

            initSelCustomer(rid); 

            form.render(null,'market-customs-declaration-form');

            table.render({
                elem: '#market-packing-list-en-table'
                ,data: ddd
                ,totalRow: false
                ,cellMinWidth: 90
                ,cols: [[
                    {field: 'marks',  title: '唛头', align:'center', totalRowText:'Total',edit: 'text'}
                    ,{field: 'qty', title: "数量", align:'center', totalRow: true,edit: 'text'}
                    ,{field: 'packages', title: '件数', align:'center', totalRow: true,edit: 'text'}
                    ,{field: 'description', align:'center', title: '品名及规格',edit: 'text'}
                    ,{field: 'grossWeight', align:'center', title: '毛重', totalRow: true,edit: 'text'}
                    ,{field: 'netWeight', align:'center', title: '净重', totalRow: true,edit: 'text'}
                    ,{field: 'measurement', align:'center', title: '尺寸',edit: 'text'}
                    ,{field: 'unitPrice', align:'center', title: '单价', edit: 'text'}
                    ,{field: 'totalPrice', align:'center', title: '总价', edit: 'text'}
                    ,{field: 'orderNo', align:'center', title: '订单号码',edit: 'text'}
                    ,{field: 'sourceSupply', align:'center', title: '货源地',edit: 'text'} 
                    ,{field: 'goodsNo', align:'center', title: '商品编号及描述',templet: '#goodsSelect',minWidth:550}
                    
                    // ,{field: 'commercialInvoiceno', align:'center', title: '发票号码',edit: 'text'}
                ]]
            });

            //监听单元格编辑
            table.on('edit(market-packing-list-en-table)', function(obj){ 
                //注：edit是固定事件名，test是table原始容器的属性 lay-filter="对应的值"
                // console.log(obj.value); //得到修改后的值
                // console.log(obj.field); //当前编辑的字段名
                // console.log(obj.data); //所在行的所有相关数据
                if(obj.field === 'totalPrice'){
                    // table.reload('market-packing-list-en-table',{data:[obj.data]})
                    let totalPrice = Number(obj.data.qty) * Number(obj.data.unitPrice);;
                    console.log(totalPrice);
                    $(obj.tr.selector + ' td[data-field="' + obj.field + '"] input').val(totalPrice);
                }
            });

             /**
             * 初始化下拉， 获取所有客户信息
             */
            function initSelCustomer(rid) {
                var _obj = requestInterface.getAllCustomer();
                var $html;
                for (let c of _obj) {
                    $html += "<option value="+c.id+">"+c.userSystemId+"</option>"
                }
                $("select[xm-select='receiverId']").append($html);

                formSelects.render('receiverId');
                if(ddd.length !== 0){
                    formSelects.value('receiverId',[rid],true);
                }
            }

            formSelects.on('receiverId', function (id, vals, val, isAdd, isDisabled) {
                //id:           点击select的id
                //vals:         当前select已选中的值
                //val:          当前select点击的值
                //isAdd:        当前操作选中or取消
                //isDisabled:   当前选项是否是disabled                    
                if(isAdd){//对form赋值
                  form.val("market-customs-declaration-form",{"customerNo":val.name});
                }else{
                   form.val("market-customs-declaration-form",{"customerNo":null});
                }
            });
            createArr();
            
            function createArr(){
                var a = ['8534009000','8534001000','8517709000','7616910000'], 
                    b = ['空白线路板','线路板贴装','刚铝板网'],
                    c = ['0','铝制'];
                let i = 1; 

                for (let index = 0; index < a.length; index++) {
                    const element = a[index];
                    let ar = {},al=[];
                    r.name = element;
                    r.value = i++;
                    for(let index = 0; index < b.length; index++){
                        const e = b[index];
                        console.log(e);
                        let br = {},bl = [];
                        br.name = e;
                        br.value = i++;
                        bl.push(br);
                        for(let index=0; index < c.length; index++){
                            const e = c[index];
                            console.log(e);
                            let cr={},cl=[];
                            cr.name = e;
                            cr.value = i++;
                            cl.push(cr);
                        }
                    }    
                }
            }
           
            
    
            var active = {
                e1: function(){
                    let oldData = table.cache["market-packing-list-en-table"],d={};
                    oldData.push(d);
                    // console.log(oldData);
                    table.reload('market-packing-list-en-table',{data:oldData})
                    formSelects.data('select15', 'local', {
                        arr: [
                            {
                                "name": "8534009000", 
                                "value": 1, 
                                "children": [
                                    {"name": "空白线路板", "value": 2, "children": [
                                        {"name": "0", "value": 3, "children": [
                                            {"name":"1层","value":4,"children":[
                                                {"name":"无牌","value":5,"children":[
                                                    {"name":"未装有机械元件或电气元件","value":6,"children":[]},
                                                    {"name":"已组装元器件","value":7,"children":[]}, 
                                                    {"name":"非工业用","value":8,"children":[]}, 
                                                ]}
                                            ]},
                                            {"name":"2层","value":9,"children":[
                                                {"name":"无牌","value":10,"children":[
                                                    {"name":"未装有机械元件或电气元件","value":11,"children":[]},
                                                    {"name":"已组装元器件","value":12,"children":[]}, 
                                                    {"name":"非工业用","value":13,"children":[]}, 
                                                ]}
                                            ]},
                                            {"name":"4层","value":14,"children":[
                                                {"name":"无牌","value":15,"children":[
                                                    {"name":"未装有机械元件或电气元件","value":16,"children":[]},
                                                    {"name":"已组装元器件","value":17,"children":[]}, 
                                                    {"name":"非工业用","value":18,"children":[]}, 
                                                ]}
                                            ]},
                                            {"name":"6层","value":19,"children":[
                                                {"name":"无牌","value":20,"children":[
                                                    {"name":"未装有机械元件或电气元件","value":21,"children":[]},
                                                    {"name":"已组装元器件","value":22,"children":[]}, 
                                                    {"name":"非工业用","value":23,"children":[]}, 
                                                ]}
                                            ]},
                                            {"name":"8层","value":24,"children":[
                                                {"name":"无牌","value":25,"children":[
                                                    {"name":"未装有机械元件或电气元件","value":26,"children":[]},
                                                    {"name":"已组装元器件","value":27,"children":[]}, 
                                                    {"name":"非工业用","value":28,"children":[]}, 
                                                ]}
                                            ]},
                                            {"name":"10层","value":29,"children":[
                                                {"name":"无牌","value":30,"children":[
                                                    {"name":"未装有机械元件或电气元件","value":31,"children":[]},
                                                    {"name":"已组装元器件","value":32,"children":[]}, 
                                                    {"name":"非工业用","value":33,"children":[]}, 
                                                ]}
                                            ]},
                                            {"name":"14层","value":34,"children":[
                                                {"name":"无牌","value":35,"children":[
                                                    {"name":"未装有机械元件或电气元件","value":36,"children":[]},
                                                    {"name":"已组装元器件","value":37,"children":[]}, 
                                                    {"name":"非工业用","value":38,"children":[]}, 
                                                ]}
                                            ]},
                                            {"name":"16层","value":39,"children":[
                                                {"name":"无牌","value":40,"children":[
                                                    {"name":"未装有机械元件或电气元件","value":41,"children":[]},
                                                    {"name":"已组装元器件","value":42,"children":[]}, 
                                                    {"name":"非工业用","value":43,"children":[]}, 
                                                ]}
                                            ]},
                                            {"name":"18层","value":44,"children":[
                                                {"name":"无牌","value":45,"children":[
                                                    {"name":"未装有机械元件或电气元件","value":46,"children":[]},
                                                    {"name":"已组装元器件","value":47,"children":[]}, 
                                                    {"name":"非工业用","value":48,"children":[]}, 
                                                ]}
                                            ]},
                                            {"name":"20层","value":49,"children":[
                                                {"name":"无牌","value":50,"children":[
                                                    {"name":"未装有机械元件或电气元件","value":51,"children":[]},
                                                    {"name":"已组装元器件","value":52,"children":[]}, 
                                                    {"name":"非工业用","value":53,"children":[]}, 
                                                ]}
                                            ]},
                                            {"name":"22层","value":54,"children":[
                                                {"name":"无牌","value":55,"children":[
                                                    {"name":"未装有机械元件或电气元件","value":56,"children":[]},
                                                    {"name":"已组装元器件","value":57,"children":[]}, 
                                                    {"name":"非工业用","value":58,"children":[]}, 
                                                ]}
                                            ]},
                                            {"name":"24层","value":59,"children":[
                                                {"name":"无牌","value":60,"children":[
                                                    {"name":"未装有机械元件或电气元件","value":61,"children":[]},
                                                    {"name":"已组装元器件","value":62,"children":[]}, 
                                                    {"name":"非工业用","value":63,"children":[]}, 
                                                ]}
                                            ]},
                                            {"name":"0","value":64,"children":[
                                                {"name":"无牌","value":65,"children":[
                                                    {"name":"未装有机械元件或电气元件","value":66,"children":[]},
                                                    {"name":"已组装元器件","value":67,"children":[]}, 
                                                    {"name":"非工业用","value":68,"children":[]}, 
                                                ]}
                                            ]},
                                            {"name":"网","value":69,"children":[
                                                {"name":"无牌","value":70,"children":[
                                                    {"name":"未装有机械元件或电气元件","value":71,"children":[]},
                                                    {"name":"已组装元器件","value":72,"children":[]}, 
                                                    {"name":"非工业用","value":73,"children":[]}, 
                                                ]}
                                            ]},
                                        ]},
                                        {"name": "铝制", "value": "铝制", "children": [

                                        ]}
                                    ]},
                                    {"name": "线路板贴装", "value": "线路板贴装", "children": [

                                    ]},
                                    {"name": "刚铝板网", "value": "刚铝板网", "children": []},
                                ]
                            },
                            {
                                "name": "8534001000", 
                                "value": "8534001000", 
                                "children": [
                                    {"name": "天津市1", "value": 51, "children": []},
                                ]
                            },
                        ],
                        linkage: true
                    });
                    // formSelects.render('select15');
                },
                e2: function(){
                    layer.confirm("你确定要删除么？",function(){  
                        let oldData = table.cache["market-packing-list-en-table"]; 
                        // console.log(oldData); 
                        oldData.splice(oldData.length-1,1);  
                        layer.msg("删除成功",{time: 10},function(){  
                            table.reload('market-packing-list-en-table',{data : oldData});  
                        });  
                    }) 
                }
            }

            $('.layui-btn.layuiadmin-btn-list').on('click', function(){
            var type = $(this).data('type');
            active[type] ? active[type].call(this) : '';
            });
        });
    }
</script>